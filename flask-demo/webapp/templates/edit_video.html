<!DOCTYPE html>
<html>
<head>
  <title>Trim Video: {{ label }}</title>
  <style>
    .slider-container {
      position: relative;
      width: 480px;
      margin-top: 1em;
    }
    .controls {
      margin-top: 2em;
    }
    #video {
      display: block;
      margin-bottom: 1em;
    }
    input[type=range] {
      width: 100%;
    }
  </style>
</head>
<body>
  {% include "components/progress.html" with context %}

  <h2>Trim Video: {{ label }}</h2>

  <!-- Debug Info -->
  <p><strong>Path:</strong> {{ video_path }}</p>
  <p><strong>MIME:</strong> {{ mimetype }}</p>

  <video id="video" width="480" controls>
    <source src="{{ video_path }}" type="{{ mimetype }}">
    Your browser does not support the video tag.
  </video>  
  <p style="font-size: 0.9rem; color: gray;"><strong>video_path:</strong> {{ video_path }}</p>
  <p style="font-size: 0.9rem; color: gray;"><strong>raw_path:</strong> {{ raw_path }}</p>

  <form method="post">
    <label>Trim Range:</label>
    <div class="slider-container">
      Start:
      <input type="range" id="trim-start-slider" min="0" max="100" step="0.01" value="0">
      End:
      <input type="range" id="trim-end-slider" min="0" max="100" step="0.01" value="100">
    </div>
    <div>
      Start Time: <span id="start-time">0.0</span> sec
      <input type="hidden" id="trim-start" name="{{ prefix }}_trim_start" value="0">
      &nbsp;&nbsp;&nbsp;
      End Time: <span id="end-time">0.0</span> sec
      <input type="hidden" id="trim-end" name="{{ prefix }}_trim_end" value="100">
    </div>

    <!-- Default crop fields -->
    <input type="hidden" name="{{ prefix }}_crop_x" value="0">
    <input type="hidden" name="{{ prefix }}_crop_y" value="0">
    <input type="hidden" name="{{ prefix }}_crop_w" value="1">
    <input type="hidden" name="{{ prefix }}_crop_h" value="1">

    <div class="controls">
      <button type="submit">Next →</button>
      {% if prev_url %}
        <a href="{{ url_for(prev_url) }}">← Back</a>
      {% endif %}
    </div>
  </form>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const video = document.getElementById("video");
      const startSlider = document.getElementById("trim-start-slider");
      const endSlider = document.getElementById("trim-end-slider");
      const trimStartInput = document.getElementById("trim-start");
      const trimEndInput = document.getElementById("trim-end");
      const startDisplay = document.getElementById("start-time");
      const endDisplay = document.getElementById("end-time");

      let duration = 100;

      video.addEventListener("loadedmetadata", () => {
        duration = video.duration;
        startSlider.max = duration;
        endSlider.max = duration;
        startSlider.step = 0.01;
        endSlider.step = 0.01;
        endSlider.value = duration;

        trimEndInput.value = duration.toFixed(2);
        endDisplay.textContent = duration.toFixed(1);
      });

      function updateSliders() {
        let startVal = parseFloat(startSlider.value);
        let endVal = parseFloat(endSlider.value);

        // Clamp to ensure start <= end
        if (startVal > endVal) {
          endVal = startVal;
          endSlider.value = endVal;
        }
        if (endVal < startVal) {
          startVal = endVal;
          startSlider.value = startVal;
        }

        trimStartInput.value = startVal.toFixed(2);
        trimEndInput.value = endVal.toFixed(2);
        startDisplay.textContent = startVal.toFixed(1);
        endDisplay.textContent = endVal.toFixed(1);

        video.currentTime = startVal;
      }

      startSlider.addEventListener("input", updateSliders);
      endSlider.addEventListener("input", updateSliders);

      video.addEventListener("timeupdate", () => {
        const current = video.currentTime;
        const start = parseFloat(trimStartInput.value);
        const end = parseFloat(trimEndInput.value);
        if (current < start) {
          video.currentTime = start;
        } else if (current > end) {
          video.pause();
        }
      });
    });
  </script>
</body>
</html>
